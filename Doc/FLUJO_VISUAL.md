# ğŸ”„ Diagrama de Flujo - Estados Green Bit

## Flujo Visual Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO DE TRABAJO GREEN BIT                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  RECICLADOR CREA REQUEST
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Request: OPEN(1) â”‚  âœ… Visible en mapa
    â”‚ Appointment: N/A â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ—ºï¸  Aparece en el mapa         â”‚
    â”‚ (Collectors pueden verlo)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  2ï¸âƒ£  COLLECTOR SOLICITA RECOGER                                          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚      â”‚ Request: REQUESTED (0)   â”‚  âŒ Oculto temporalmente               â”‚
â”‚      â”‚ Appointment: PENDING (0) â”‚                                        â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                 â”‚                                                         â”‚
â”‚                 â”‚  ğŸ“© NotificaciÃ³n al Reciclador                         â”‚
â”‚                 â–¼                                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚      â”‚ Reciclador recibe      â”‚                                          â”‚
â”‚      â”‚ notificaciÃ³n y decide  â”‚                                          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                 â”‚                                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚      â–¼                     â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚ ACEPTA  â”‚         â”‚ RECHAZA  â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚      â”‚                     â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â–¼                     â–¼

3ï¸âƒ£a ACEPTADO                3ï¸âƒ£b RECHAZADO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request: ACCEPTED  â”‚      â”‚ Request: OPEN (1)    â”‚  âœ… Vuelve al mapa
â”‚ Appointment:       â”‚      â”‚ Appointment:         â”‚
â”‚   ACCEPTED (1)     â”‚      â”‚   REJECTED (3)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚
       â”‚ ğŸ“© Notifica Collector     â”‚ ğŸ“© Notifica Collector
       â–¼                           â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ ğŸ”„ Disponible    â”‚
                             â”‚ para otros       â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  4ï¸âƒ£  OPCIONES DESPUÃ‰S DE ACEPTAR                                         â”‚
â”‚                                                                           â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚      â”‚  Request: ACCEPTED  â”‚                                             â”‚
â”‚      â”‚  Appointment:       â”‚                                             â”‚
â”‚      â”‚    ACCEPTED (1)     â”‚                                             â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚              â”‚                                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚    â–¼                    â–¼                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚CANCELAR â”‚       â”‚COMPLETAR â”‚                                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚    â”‚                    â”‚                                                â”‚
â”‚    â–¼                    â–¼                                                â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5ï¸âƒ£a CANCELADO                  5ï¸âƒ£b COMPLETADO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request: OPEN (1)    â”‚ âœ…     â”‚ Request: CLOSED (4)  â”‚ ğŸ
â”‚ Appointment:         â”‚        â”‚ Appointment:         â”‚
â”‚   CANCELLED (5)      â”‚        â”‚   COMPLETED (4)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
       â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ Vuelve al     â”‚          â”‚ âœ… Proceso finalizadoâ”‚
â”‚    mapa          â”‚          â”‚    exitosamente      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Tabla Resumen de Transiciones

| Desde Estado    | AcciÃ³n             | Request         | Appointment     | En Mapa |
| --------------- | ------------------ | --------------- | --------------- | ------- |
| -               | Crear Request      | `OPEN (1)`      | -               | âœ… SÃ   |
| `OPEN (1)`      | Collector solicita | `REQUESTED (0)` | `PENDING (0)`   | âŒ NO   |
| `REQUESTED (0)` | Reciclador acepta  | `ACCEPTED (2)`  | `ACCEPTED (1)`  | âŒ NO   |
| `REQUESTED (0)` | Reciclador rechaza | `OPEN (1)`      | `REJECTED (3)`  | âœ… SÃ   |
| `ACCEPTED (2)`  | Cancelar           | `OPEN (1)`      | `CANCELLED (5)` | âœ… SÃ   |
| `ACCEPTED (2)`  | Completar          | `CLOSED (4)`    | `COMPLETED (4)` | âŒ NO   |

---

## ğŸ¨ Colores de Estados (UI)

```
REQUEST STATES:
â”œâ”€ REQUESTED (0)  ğŸŸ¡ Amarillo  (Temporal/Bloqueado)
â”œâ”€ OPEN (1)       ğŸŸ¢ Verde     (Disponible)
â”œâ”€ ACCEPTED (2)   ğŸ”µ Azul      (En proceso)
â”œâ”€ REJECTED (3)   ğŸ”´ Rojo      (Rechazado)
â”œâ”€ CLOSED (4)     âš« Gris      (Finalizado)
â””â”€ CANCELLED (5)  ğŸŸ  Naranja   (Cancelado)

APPOINTMENT STATES:
â”œâ”€ PENDING (0)     ğŸŸ¡ Amarillo  (Esperando)
â”œâ”€ ACCEPTED (1)    ğŸ”µ Azul      (Confirmado)
â”œâ”€ IN_PROGRESS (2) ğŸŸ£ PÃºrpura   (En curso)
â”œâ”€ REJECTED (3)    ğŸ”´ Rojo      (Rechazado)
â”œâ”€ COMPLETED (4)   ğŸŸ¢ Verde     (Completado)
â””â”€ CANCELLED (5)   ğŸŸ  Naranja   (Cancelado)
```

---

## ğŸ“± Acciones por Rol

### RECICLADOR (DueÃ±o del material)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Estado PENDING (0)                     â”‚
â”‚ âœ… Aceptar solicitud                   â”‚
â”‚ âŒ Rechazar solicitud                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Estado ACCEPTED (1)                    â”‚
â”‚ âœ“  Completar recolecciÃ³n               â”‚
â”‚ ğŸš« Cancelar cita                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### COLLECTOR (Recolector)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ver Mapa                               â”‚
â”‚ ğŸ—ºï¸  Clickear marcador OPEN             â”‚
â”‚ ğŸ“ Agendar fecha/hora                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Estado ACCEPTED (1)                    â”‚
â”‚ âœ“  Completar recolecciÃ³n               â”‚
â”‚ ğŸš« Cancelar cita                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Permisos Actuales

| AcciÃ³n                | Reciclador | Collector | Admin |
| --------------------- | ---------- | --------- | ----- |
| Crear Request         | âœ…         | âŒ        | âœ…    |
| Solicitar Recoger     | âŒ         | âœ…        | âœ…    |
| Aceptar Solicitud     | âœ…         | âŒ        | âœ…    |
| Rechazar Solicitud    | âœ…         | âŒ        | âœ…    |
| Cancelar Cita         | âœ…         | âœ…        | âœ…    |
| Completar RecolecciÃ³n | âœ…         | âœ…        | âœ…    |

---

## ğŸ”” Sistema de Notificaciones

```
EVENTO                    â”‚ NOTIFICA A      â”‚ MENSAJE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Collector solicita        â”‚ Reciclador      â”‚ "Solicitud de recolecciÃ³n"
Reciclador acepta         â”‚ Collector       â”‚ "Tu solicitud fue aceptada"
Reciclador rechaza        â”‚ Collector       â”‚ "Tu solicitud fue rechazada"
Cualquiera cancela        â”‚ Ambos           â”‚ "La cita fue cancelada"
Cualquiera completa       â”‚ Ambos           â”‚ "RecolecciÃ³n completada"
```

---

## ğŸ› Debugging - Checkpoints

### Backend

```javascript
// En appointmentModel.js
console.log("[INFO] createAppointment - request state:", requestState);
console.log("[INFO] acceptAppointment - transitions:", { from, to });
```

### Frontend

```typescript
// En PickupInfo.tsx
console.log("Current appointment state:", appointmentData.state);
console.log("Action triggered:", actionName);
```

### Base de Datos

```sql
-- Ver estados actuales
SELECT
  r.id as request_id,
  r.state as request_state,
  ac.id as appointment_id,
  ac.state as appointment_state
FROM request r
LEFT JOIN appointmentconfirmation ac ON ac.idRequest = r.id
ORDER BY r.registerDate DESC
LIMIT 10;
```

---

**Nota**: Este flujo garantiza que ninguna request se pierda y que siempre haya trazabilidad completa del proceso.
